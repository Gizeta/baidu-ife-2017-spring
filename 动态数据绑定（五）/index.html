<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Document</title>
</head>
<body>
    <textarea id="t1" style="width:500px;height:300px;">
<div id="app">
    <p style="color:red">姓名：{{user.name}}</p>
    <p>年龄：{{user.age}}</p>
</div>
    </textarea>
    <button id="b1">render一下</button>
    <textarea id="t2" style="width:500px;height:300px;">
window.app = new Vue({
    el: '#app',
    data: {
        user: {
            name: 'youngwind',
            age: 25
        },
        school: 'bupt',
        major: 'computer'
    }
});

// window.app.data.user.name = "test";
// window.app.data.school = "test";
    </textarea>
    <button id="b2">eval一下</button>
    <hr/>
    <h3>Result:</h3>
    <div id="result">

    </div>

    <script>
    // Vue class region
    {
        let scope = {}; // exported class refs
        
        // inner scope(Observer)
        {
            // private field keys
            const $$propWatchHash = Symbol('propWatchHash');
            const $$parent = Symbol('parent');
            const $$parentPath = Symbol('parentPath');

            class Observer {
                constructor(data, parent, parentPath) {
                    this[$$propWatchHash] = {};
                    this[$$parent] = parent;
                    this[$$parentPath] = parentPath;

                    // 递归转化
                    for (let key of Object.keys(data)) {
                        if (typeof data[key] === "object") {
                            data[key] = new Observer(data[key], this, key);
                        }
                    }
                    this.data = new Proxy(data, {
                        get: (obj, prop) => {
                            if (prop === $$propWatchHash)
                                return this[$$propWatchHash];

                            if (obj[prop] instanceof Observer)
                                return obj[prop].data;
                            else
                                return obj[prop];
                        },
                        set: (obj, prop, value) => {
                            console.log(`try to update ${prop}`);

                            if (typeof value === "object")
                                obj[prop] = new Observer(value, this);
                            else
                                obj[prop] = value;

                            if (this[$$propWatchHash][prop] != null) {
                                this[$$propWatchHash][prop](value);
                            }

                            // 判断上层监听
                            let parentPath = this[$$parentPath];
                            let parent = this[$$parent];
                            while (parent != null) {
                                if (parent[$$propWatchHash][parentPath] != null) {
                                    parent[$$propWatchHash][parentPath](parent.data[parentPath]);
                                }
                                parentPath = parent[$$parentPath];
                                parent = parent[$$parent];
                            }
                        }
                    });
                }

                $watch(prop, callback) {
                    let path = prop.split('.');
                    let target = this.data;
                    let i = 0;
                    while (i < path.length - 1) {
                        target = target[path[i]];
                        i++;
                    }
                    target[$$propWatchHash][path[i]] = callback;
                }
            }
            // export to parent scope
            scope.Observer = Observer;
        }

        // inner scope(SimpleVDOM)
        {
            // private field keys
            const $$children = Symbol('children');
            const $$tag = Symbol('tag');
            const $$attrs = Symbol('attrs');
            const $$data = Symbol('data');
            // private method keys
            const $$parse = Symbol('parse');

            class SimpleVDOM {
                constructor(htmlText, data, changedCallback) {
                    this[$$children] = [];
                    this[$$attrs] = "";
                    this[$$data] = data;
                    this[$$parse](htmlText, changedCallback);
                }

                [$$parse](htmlText, changedCallback) {
                    let nodes = new DOMParser().parseFromString(htmlText, "text/html").body.childNodes;

                    // nothing except whitespace
                    if (nodes.length === 0) {
                        this[$$tag] = "TextNode";
                        this[$$children] = "";
                        return;
                    }

                    // pure text or dom
                    if (nodes.length == 1) {
                        let node = nodes[0];
                        // TextNode
                        if (node.nodeType === 3) {
                            this[$$tag] = "TextNode";
                            this[$$children] = node.textContent;
                            // set listener
                            let matches = node.textContent.match(/\{\{.+?\}\}/gm);
                            if (matches == null) return;
                            for (let vars of matches) {
                                let v = vars.match(/\{\{(.+)\}\}/)[1];
                                this[$$data].$watch(v.trim(), () => {
                                    console.log(`${v.trim()} has changed`);
                                    changedCallback();
                                });
                            }
                        }
                        // DOM
                        else {
                            this[$$tag] = node.nodeName;
                            this[$$children].push(new SimpleVDOM(node.innerHTML, this[$$data], changedCallback));
                            let attrs = [''];
                            for (let a of node.attributes) {
                                attrs.push(`${a.localName}="${a.value}"`);
                            }
                            this[$$attrs] = attrs.join(' ');
                        }
                        return;
                    }

                    // multiple nodes
                    for (let node of nodes) {
                        if (node.nodeType == 3)
                            this[$$children].push(new SimpleVDOM(node.textContent, this[$$data], changedCallback));
                        else
                            this[$$children].push(new SimpleVDOM(node.outerHTML, this[$$data], changedCallback));
                    }
                }

                render() {
                    // pure text
                    if (this[$$tag] == "TextNode") {
                        // data helper
                        let dataHelper = (prop) => {
                            let paths = prop.split('.');
                            let val = this[$$data].data;
                            for (let path of paths) {
                                val = val[path];
                            }
                            return val;
                        }

                        let result = this[$$children];

                        let matches = result.match(/\{\{(.+?)\}\}/gm);
                        if (matches == null) return result;
                        for (let vars of matches) {
                            let v = vars.match(/\{\{(.+)\}\}/)[1];
                            result = result.replace(`${vars}`, dataHelper(v.trim()));
                        }
                        return result;
                    }
                    // container
                    else if (this[$$tag] == null) {
                        let result = "";
                        for (let child of this[$$children]) {
                            result += child.render();
                        }
                        return result;
                    }
                    // dom
                    else {
                        let result = "";
                        for (let child of this[$$children]) {
                            result += child.render();
                        }
                        return `<${this[$$tag]}${this[$$attrs]}>${result}</${this[$$tag]}>`;
                    }
                }
            }
            //export to parent scope
            scope.SimpleVDOM = SimpleVDOM;
        }

        // inner scope(Vue)
        {
            // import defined class
            const SimpleVDom = scope.SimpleVDOM;
            const Observer = scope.Observer;
            
            // private field keys
            const $$vdom = Symbol('vdom');
            const $$target = Symbol('target');
            const $$data = Symbol('data');

            class Vue {
                constructor(options) {
                    if (options == null)
                        throw(new Error('options not found'));
                    if (typeof options !== "object")
                        throw(new Error('options should be an object'));
                    if (options.el == null)
                        throw(new Error('el not found'));
                    if (options.data == null)
                        throw(new Error('data not found'));
                    if (typeof options.data !== "object")
                        throw(new Error('data should be an object'));
                    
                    this[$$target] = document.querySelector(options.el);
                    if (this[$$target] == null)
                        throw(new Error('element not exist'));
                    
                    this[$$data] = new Observer(options.data);
                    this.data = this[$$data].data;
                    this[$$vdom] = new SimpleVDom(this[$$target].innerHTML, this[$$data], () => {
                        console.log('begin to rerender');
                        this.render();
                    });

                    this.render();
                }

                render() {
                    this[$$target].innerHTML = this[$$vdom].render();
                }
            }
            // export to global
            window.Vue = Vue;
        }
    }

    window.onload = () => {
        document.querySelector('#b1').onclick = () => {
            document.querySelector('#result').innerHTML = document.querySelector('#t1').value;
        }
        document.querySelector('#b2').onclick = () => {
            eval(document.querySelector('#t2').value);
        }
    }
    </script>
</body>
</html>